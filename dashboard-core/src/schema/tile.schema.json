{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://humanai.convention/schemas/tile-bundle.schema.json",
  "title": "TileBundle",
  "type": "object",
  "required": ["specVersion", "tiles"],
  "properties": {
    "specVersion": { "type": "string", "const": "1.0.0" },
    "generatedAt": { "type": "string", "format": "date-time" },
    "extensions": { "type": "object", "additionalProperties": true },
    "tiles": {
      "type": "array",
      "items": { "$ref": "#/definitions/Tile" },
      "minItems": 1
    }
  },
  "definitions": {
    "BaseTileMeta": {
      "type": "object",
      "required": ["id", "kind"],
      "properties": {
        "id": { "type": "string", "pattern": "^[a-z0-9][a-z0-9-]{1,62}$" },
        "kind": { "$ref": "#/definitions/TileKind" },
        "title": { "type": ["string", "null"] },
        "description": { "type": ["string", "null"] },
        "updatedAt": { "type": "string", "format": "date-time" },
        "contentVersion": { "type": "string" },
        "author": {
          "oneOf": [
            { "type": "string" },
            {
              "type": "object",
              "properties": {
                "name": { "type": "string" },
                "url": { "type": "string", "format": "uri" },
                "id": { "type": "string" }
              },
              "required": ["name"],
              "additionalProperties": false
            }
          ]
        },
        "tags": { "type": "array", "items": { "type": "string", "pattern": "^[a-z0-9][a-z0-9-]+$" }, "uniqueItems": true },
        "citations": { "type": "array", "items": { "type": "string" }, "uniqueItems": true },
        "license": { "type": "string" },
        "notes": { "type": "string" },
        "requires": { "type": "array", "items": { "type": "string" }, "uniqueItems": true },
        "i18n": {
          "type": "object",
          "additionalProperties": {
            "type": "object",
            "properties": {
              "title": { "type": ["string", "null"] },
              "description": { "type": ["string", "null"] },
              "notes": { "type": ["string", "null"] }
            },
            "additionalProperties": false
          }
        },
        "extensions": {
          "type": "object",
          "propertyNames": { "pattern": ":" },
          "additionalProperties": true
        }
      },
      "additionalProperties": false
    },
    "TileKind": {
      "type": "string",
      "enum": ["citation", "metric", "visual", "scenario", "fork", "annotation", "dataset", "composite"]
    },
    "MetricTile": {
      "allOf": [
        { "$ref": "#/definitions/BaseTileMeta" },
        {
          "type": "object",
          "properties": {
            "kind": { "const": "metric" },
            "metric": {
              "type": "object",
              "required": ["key"],
              "properties": {
                "key": { "type": "string" },
                "unit": { "type": "string" },
                "value": { "type": "number" },
                "series": {
                  "type": "array",
                  "items": { "type": "object", "required": ["t", "v"], "properties": { "t": { "type": "string", "format": "date-time" }, "v": { "type": "number" } }, "additionalProperties": false }
                },
                "ci95": { "type": "array", "items": { "type": "number" }, "minItems": 2, "maxItems": 2 },
                "source": { "type": "string" }
              },
              "additionalProperties": false
            }
          },
          "required": ["metric"]
        }
      ]
    },
    "CitationTile": {
      "allOf": [
        { "$ref": "#/definitions/BaseTileMeta" },
        {
          "type": "object",
          "properties": {
            "kind": { "const": "citation" },
            "citationId": { "type": "string" },
            "highlight": { "type": "string" }
          },
          "required": ["citationId"]
        }
      ]
    },
    "VisualTile": {
      "allOf": [
        { "$ref": "#/definitions/BaseTileMeta" },
        {
          "type": "object",
          "properties": {
            "kind": { "const": "visual" },
            "visual": {
              "type": "object",
              "required": ["type"],
              "properties": {
                "type": { "type": "string" },
                "spec": {},
                "src": { "type": "string", "format": "uri" },
                "aspectRatio": { "type": "number" }
              },
              "additionalProperties": true
            }
          },
          "required": ["visual"]
        }
      ]
    },
    "ScenarioTile": {
      "allOf": [
        { "$ref": "#/definitions/BaseTileMeta" },
        {
          "type": "object",
          "properties": {
            "kind": { "const": "scenario" },
            "scenario": {
              "type": "object",
              "required": ["premise"],
              "properties": {
                "premise": { "type": "string" },
                "question": { "type": "string" },
                "branches": {
                  "type": "array",
                  "items": {
                    "type": "object",
                    "required": ["id", "label"],
                    "properties": {
                      "id": { "type": "string" },
                      "label": { "type": "string" },
                      "outcome": { "type": "string" },
                      "next": { "type": "array", "items": { "type": "string" }, "uniqueItems": true }
                    },
                    "additionalProperties": false
                  }
                }
              },
              "additionalProperties": false
            }
          },
          "required": ["scenario"]
        }
      ]
    },
    "ForkTile": {
      "allOf": [
        { "$ref": "#/definitions/BaseTileMeta" },
        {
          "type": "object",
          "properties": {
            "kind": { "const": "fork" },
            "fork": {
              "type": "object",
              "required": ["from"],
              "properties": {
                "from": { "oneOf": [ { "type": "string" }, { "type": "array", "items": { "type": "string" }, "minItems": 1 } ] },
                "rationale": { "type": "string" },
                "changes": { "type": "array", "items": { "type": "string" }, "uniqueItems": true }
              },
              "additionalProperties": false
            }
          },
          "required": ["fork"]
        }
      ]
    },
    "DatasetTile": {
      "allOf": [
        { "$ref": "#/definitions/BaseTileMeta" },
        {
          "type": "object",
          "properties": {
            "kind": { "const": "dataset" },
            "dataset": {
              "type": "object",
              "required": ["format"],
              "properties": {
                "format": { "type": "string" },
                "rows": { "type": "number" },
                "sizeBytes": { "type": "number" },
                "hash": { "type": "string" },
                "schema": {
                  "type": "array",
                  "items": {
                    "type": "object",
                    "required": ["name", "type"],
                    "properties": {
                      "name": { "type": "string" },
                      "type": { "type": "string" },
                      "description": { "type": "string" }
                    },
                    "additionalProperties": false
                  }
                },
                "source": { "type": "string" }
              },
              "additionalProperties": false
            }
          },
          "required": ["dataset"]
        }
      ]
    },
    "CompositeTile": {
      "allOf": [
        { "$ref": "#/definitions/BaseTileMeta" },
        {
          "type": "object",
          "properties": {
            "kind": { "const": "composite" },
            "children": { "type": "array", "items": { "type": "string" }, "minItems": 1, "uniqueItems": true },
            "layout": { "type": "string", "enum": ["sequence", "grid", "tabs"] }
          },
          "required": ["children"]
        }
      ]
    },
    "AnnotationTile": {
      "allOf": [
        { "$ref": "#/definitions/BaseTileMeta" },
        {
          "type": "object",
          "properties": {
            "kind": { "const": "annotation" },
            "target": { "type": "string" },
            "body": { "type": "string" },
            "format": { "type": "string", "enum": ["markdown", "plaintext", "html"] }
          },
          "required": ["target", "body"]
        }
      ]
    },
    "Tile": {
      "oneOf": [
        { "$ref": "#/definitions/MetricTile" },
        { "$ref": "#/definitions/CitationTile" },
        { "$ref": "#/definitions/VisualTile" },
        { "$ref": "#/definitions/ScenarioTile" },
        { "$ref": "#/definitions/ForkTile" },
        { "$ref": "#/definitions/DatasetTile" },
        { "$ref": "#/definitions/CompositeTile" },
        { "$ref": "#/definitions/AnnotationTile" }
      ]
    }
  }
}
