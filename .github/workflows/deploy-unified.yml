name: Unified CI & Deploy

################################################################################
# Action Pin Table (Generated 2025-09-28)
# Format: <action> <tag> <commit-sha>
# actions/checkout v5.0.0 08c6903cd8c0fde910a37f88322edcfb5dd907a8
# actions/setup-node v5.0.0 a0853c24544627f65ddf259abe73b1d18a591444
# actions/upload-artifact v4.6.2 ea165f8d65b6e75b540449e92b4886f43607fa02
# actions/upload-pages-artifact v4.0.0 7b1f4a764d45c48632c6b24a0339c27f5614fb0b
# actions/deploy-pages v4.0.5 d6db90164ac5ed86f2b6aed7e0febac5b3c0c03e
# peter-evans/create-or-update-comment v4.0.0 71345be0265236311c031f5c7866368bd1eff043
################################################################################

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write
  pull-requests: write

concurrency:
  group: unified-${{ github.ref }}
  cancel-in-progress: true

jobs:
  quality:
    name: Quality Gates
    runs-on: ubuntu-latest
    env:
      NODE_VERSION: '20'
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - name: Setup Node
        uses: actions/setup-node@a0853c24544627f65ddf259abe73b1d18a591444 # v5.0.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
      - name: Install deps (root + web)
        run: |
          npm ci
          npm --workspace web ci || (cd web && npm install)
      - name: Lint
        run: npm run lint
      - name: Typecheck
        run: npm run typecheck
      - name: Unit Tests
        run: npm test
      - name: Coverage (non-blocking)
        run: npm run test:coverage || echo "Coverage step failed or not present"
      - name: Upload Coverage Artifact
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: coverage
          path: web/coverage
          if-no-files-found: ignore
          retention-days: 5

  deploy:
    name: Build & Deploy Pages
    needs: quality
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment: github-pages
    env:
      NODE_VERSION: '20'
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - name: Setup Node
        uses: actions/setup-node@a0853c24544627f65ddf259abe73b1d18a591444 # v5.0.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
      - name: Install deps (root + web)
        run: |
          npm ci
          npm --workspace web ci || (cd web && npm install)
      - name: Build Site
        run: |
          cd web
          if [ -n "$CUSTOM_DOMAIN" ]; then
            export PUBLIC_BASE_PATH='/'
            echo "Custom domain detected: $CUSTOM_DOMAIN (base=/)"
          else
            export PUBLIC_BASE_PATH="/${{ github.event.repository.name }}"
            echo "No custom domain; using base $PUBLIC_BASE_PATH"
          fi
          PUBLIC_BASE_PATH=$PUBLIC_BASE_PATH npm run build
          echo "Commit: $GITHUB_SHA" > dist/DEPLOY_MARKER.txt
          if [ -f public/health.txt ]; then cp public/health.txt dist/health.txt; else echo "OK" > dist/health.txt; fi
          BUILD_TIME=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          jq -n --arg commit "$GITHUB_SHA" --arg time "$BUILD_TIME" --arg ref "${GITHUB_REF#refs/heads/}" '{commit:$commit,time:$time,ref:$ref}' > dist/version.json
          # Inject meta tag (before closing head) & window.__APP_VERSION__
          if grep -q '</head>' dist/index.html; then
            sed -i "s#</head>#<meta name=\"x-app-version\" content=\"$GITHUB_SHA\" />\n<script>window.__APP_VERSION__=$(cat dist/version.json)</script>\n</head>#" dist/index.html || true
          fi
      - name: Dist Diagnostics
        run: |
          echo "Listing dist:"; ls -al web/dist | head -80
          echo "Marker:"; cat web/dist/DEPLOY_MARKER.txt || true
          echo "Health:"; cat web/dist/health.txt || true
          [ -f web/dist/DEPLOY_MARKER.txt ] || { echo "Missing marker"; exit 1; }
          [ -f web/dist/health.txt ] || { echo "Missing health"; exit 1; }
      - name: Inject CNAME (if custom domain)
        run: |
          if [ -n "$CUSTOM_DOMAIN" ]; then echo "$CUSTOM_DOMAIN" > web/dist/CNAME; fi
      - name: Upload Pages Artifact
        uses: actions/upload-pages-artifact@7b1f4a764d45c48632c6b24a0339c27f5614fb0b # v4.0.0
        with:
          path: web/dist
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@d6db90164ac5ed86f2b6aed7e0febac5b3c0c03e # v4.0.5
      - name: Uptime Smoke Test
        run: |
          URL="${{ steps.deployment.outputs.page_url }}"
          echo "Probing $URL ..."
          for i in 1 2 3 4 5; do
            code=$(curl -s -o /dev/null -w '%{http_code}' "$URL" || echo 000)
            echo "Attempt $i -> $code"; [ "$code" = "200" ] && break; sleep 3;
          done
          curl -I "$URL/DEPLOY_MARKER.txt" || true
          curl -I "$URL/health.txt" || true
      - name: (Optional) Webhook Placeholder
        if: ${{ false }}
        run: echo "Add webhook curl here (disabled)"
      - name: Deployment Summary
        run: |
          echo "Deployment URL: ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY
          echo "Commit: $GITHUB_SHA" >> $GITHUB_STEP_SUMMARY
          echo "Base Path: ${PUBLIC_BASE_PATH:-/(computed by vite)}" >> $GITHUB_STEP_SUMMARY
          echo "Version JSON: ${{ steps.deployment.outputs.page_url }}/version.json" >> $GITHUB_STEP_SUMMARY
      - name: Slack Notify (optional)
        if: success() && env.SLACK_WEBHOOK_URL != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          payload=$(jq -n --arg url "${{ steps.deployment.outputs.page_url }}" --arg sha "$GITHUB_SHA" '{text:"Deploy succeeded", url:$url, commit:$sha}')
          curl -X POST -H 'Content-type: application/json' --data "$payload" "$SLACK_WEBHOOK_URL" || echo "Slack notify failed"

  lighthouse:
    name: Lighthouse & Perf (gradual)
    needs: quality
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    env:
      NODE_VERSION: '20'
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - uses: actions/setup-node@a0853c24544627f65ddf259abe73b1d18a591444 # v5.0.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
      - name: Install deps (web)
        run: |
          npm --workspace web ci || (cd web && npm install)
      - name: Build preview server
        working-directory: web
        run: npm run build
      - name: Run Lighthouse (if script exists)
        working-directory: web
        run: |
          if npm run | grep -q 'lhci'; then npm run lhci || echo 'Lighthouse failed (non-blocking)'; else echo 'No lhci script'; fi
      - name: Perf budget (if script exists)
        working-directory: web
        run: |
          if npm run | grep -q 'perf:check'; then npm run perf:check || echo 'Perf check failed (non-blocking)'; else echo 'No perf:check script'; fi
      - name: Upload Lighthouse Artifacts
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: lighthouse-gradual
          path: web/.lighthouseci
          if-no-files-found: ignore

  pr-preview:
    name: PR Ephemeral Preview
    if: github.event_name == 'pull_request'
    needs: quality
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pages: write
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - name: Setup Node
        uses: actions/setup-node@a0853c24544627f65ddf259abe73b1d18a591444 # v5.0.0
        with:
          node-version: 20
          cache: npm
      - name: Install deps
        run: |
          npm ci
          npm --workspace web ci || (cd web && npm install)
      - name: Build (PR preview base)
        run: |
          cd web
          export PUBLIC_BASE_PATH="/pr-${{ github.event.pull_request.number }}"
          echo "Preview base: $PUBLIC_BASE_PATH"
          PUBLIC_BASE_PATH=$PUBLIC_BASE_PATH npm run build
          echo "Commit: $GITHUB_SHA" > dist/DEPLOY_MARKER.txt
          echo "OK" > dist/health.txt
          echo "PR Preview for #${{ github.event.pull_request.number }}" > dist/preview-info.txt
      - name: Upload Preview Artifact
        uses: actions/upload-pages-artifact@7b1f4a764d45c48632c6b24a0339c27f5614fb0b # v4.0.0
        with:
          path: web/dist
      - name: Deploy Preview
        id: pr_deploy
        uses: actions/deploy-pages@d6db90164ac5ed86f2b6aed7e0febac5b3c0c03e # v4.0.5
      - name: Comment Preview URL
        uses: peter-evans/create-or-update-comment@71345be0265236311c031f5c7866368bd1eff043 # v4.0.0
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ðŸ§ª PR Preview Ready
            URL: ${{ steps.pr_deploy.outputs.page_url }}pr-${{ github.event.pull_request.number }}/
            Commit: `${{ github.sha }}`
            (Base: /pr-${{ github.event.pull_request.number }})

  preview-comment:
    name: PR Preview Note
    if: github.event_name == 'pull_request'
    needs: quality
    runs-on: ubuntu-latest
    steps:
      - name: Comment (no deploy for PR)
        uses: peter-evans/create-or-update-comment@71345be0265236311c031f5c7866368bd1eff043 # v4.0.0
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            âœ… Quality checks completed.
            This PR does not auto-deploy; merge to main to publish.
